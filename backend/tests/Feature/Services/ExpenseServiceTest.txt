<?php

namespace Tests\Feature\Services;

use App\Models\{Property, User};
use App\Services\Expenses\ExpenseService;
use Tests\TestHelper;

/**
 * @mixin TestHelper
 * @property \App\Models\User $user
 * @property \App\Models\Property $property
 */

beforeEach(function () {
    /** @var TestHelper $this */
    $this->loginAsNewUser();
    $this->property = Property::factory()->create(['user_id' => $this->user->id]);
});

it('crée et met à jour une dépense liée à un bien', function () {
    $service = app(ExpenseService::class);

    $expense = $service->create([
        'property_id' => $this->property->id,
        'category' => 'Entretien',
        'amount' => 3000,
        'date' => now(),
        'note' => 'Réparation douche',
    ]);

    expect($expense->amount)->toBe(3000);

    $updated = $service->update($expense, ['amount' => 4000]);
    expect($updated->amount)->toBe(4000);
});
it('empêche la création de dépense pour un bien d\'un autre utilisateur', function () {
    $service = app(ExpenseService::class);
    $otherUser = User::factory()->create();
    $otherProperty = Property::factory()->create(['user_id' => $otherUser->id]);

    $this->expectExceptionCode(403);
    $service->create([
        'property_id' => $otherProperty->id,
        'category' => 'Réparations',
        'amount' => 1500,
        'date' => now(),
        'note' => 'Peinture murale',
    ]);
});